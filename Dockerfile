FROM mongo:4.4

ENV CVE_BASE=/opt/cve
ENV PATH=${PATH}:${CVE_BASE}/bin

ARG REPO=cve-search/cve-search
ARG BRANCH=master

RUN echo "Using repo - branch: ${REPO} - ${BRANCH}"


RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        git \
        python3 \
        python3-pip \
        python3-lxml \
        python3-dev \
        gcc \
        redis-server && \
    mv /usr/local/bin/docker-entrypoint.sh /usr/local/bin/mongo-entrypoint.sh && \
    apt-get autoremove -y python3-dev gcc && \
    rm -rf /var/lib/apt/lists/*

RUN git clone -b ${BRANCH} --single-branch --depth=1 https://github.com/${REPO}.git ${CVE_BASE} && \
    pip3 install -r ${CVE_BASE}/requirements.txt

ADD ./files/configuration.ini ${CVE_BASE}/etc/configuration.ini
ADD ./files/auth.txt ${CVE_BASE}/etc/auth.txt
ADD docker-entrypoint.sh /usr/local/bin/cvedb

EXPOSE 5000
ENTRYPOINT ["cvedb"]
CMD ["-c", "-w"]
